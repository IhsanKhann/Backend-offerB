name: CI/CD Deploy

on:
  push:
    branches:
      - main
      - develop

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # 1️⃣ Checkout code
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 2️⃣ Set environment + compose file
      - name: Set Deployment Variables
        run: |
          if [ "${GITHUB_REF}" = "refs/heads/main" ]; then
            echo "COMPOSE_FILE=docker-compose.prod.yml" >> $GITHUB_ENV
            echo "ENV_FILE=.env.production" >> $GITHUB_ENV
          else
            echo "COMPOSE_FILE=docker-compose.dev.yml" >> $GITHUB_ENV
            echo "ENV_FILE=.env.development" >> $GITHUB_ENV
          fi

      # 3️⃣ Stop old containers safely
      - name: Stop Old Containers
        run: |
          docker compose -f $COMPOSE_FILE --env-file $ENV_FILE down || true

      # 4️⃣ Build and start containers
      - name: Build and Start Containers
        run: |
          docker compose -f $COMPOSE_FILE --env-file $ENV_FILE up -d --build

      # 5️⃣ Show running containers
      - name: Show Running Containers
        run: docker ps